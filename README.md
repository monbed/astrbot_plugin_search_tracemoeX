# TraceMoe 动漫场景识别插件

基于 trace.moe API 的 AstrBot 插件，可以通过图片识别动漫出处。支持 API 密钥配置、预览媒体、结果数量可配、配额查询等高级功能。

## 功能特性

- 🔍 **动漫场景识别** - 通过截图识别动漫、时间戳和集数
- 🖼️ **图片上传支持** - 直接发送图片进行识别  
- 📊 **详细结果** - 显示相似度、动漫信息、时间戳等
- 🌐 **AniList集成** - 获取详细的动漫信息
- 📱 **静态图片支持** - JPG、PNG、GIF、WebP等静态图片格式
- ✨ **智能裁切** - 自动裁切黑边，提高识别准确度
- 🔑 **API 密钥支持** - 配置 API 密钥提高配额和并发限制
- 🎬 **预览媒体** - 支持显示第一条结果的图片预览
- 📋 **配额查询** - 管理员可查看 API 使用情况和剩余配额
- 🛠️ **灵活配置** - 支持自定义 API 地址、结果数量等
- 💬 **引用消息支持** - 支持对引用消息中的图片进行识别
- ⏱️ **等待模式** - 输入命令后等待图片输入，超时自动取消

## 使用方法

### 基本指令

```bash
/搜番              # 搜索动漫场景（发送图片或引用消息）
/搜番帮助          # 显示插件帮助信息
```

### 管理员指令

```bash
/搜番配额          # 查询 API 配额使用情况（仅管理员）
```

## 使用示例

1. **直接搜索图片**：
   发送 `/搜番` 指令并同时发送图片（自动裁切黑边）

2. **引用消息搜索**：
   回复有图片的消息并发送 `/搜番`

3. **等待模式**：
   发送 `/搜番` 后，30秒内发送图片进行搜索

4. **查看帮助**：
   ```bash
   /搜番帮助
   ```

5. **查询配额**（仅管理员）：
   ```bash
   /搜番配额
   ```

## 搜索结果说明

插件会返回最相关的搜索结果（可配置1-10条），包含：

- 🎌 **动漫名称** - 日文原名或罗马音
- 📊 **相似度** - 百分比显示匹配程度
- ⏰ **时间戳** - 场景在动漫中的具体时间
- 📺 **集数信息** - 如果可识别的话
- 🔗 **MyAnimeList链接** - 查看详细信息

### 准确度说明

- **≥90%** - 结果通常准确可信
- **<90%** - 仅供参考

## API 限制与说明

### 访客模式（无 API 密钥）
- **搜索配额**：每月 1000 次
- **并发限制**：1 个并发请求
- **优先级**：0（最低）

### API 密钥模式
- **搜索配额**：根据付费计划而定
- **并发限制**：更高的并发数
- **优先级**：更高的队列优先级

### 通用限制
- **图片大小**：最大 25MB  
- **支持格式**：静态图片（jpg, png, gif, webp等）
- **推荐尺寸**：640x360px 以获得最佳识别效果

## 技术特性

- 异步 HTTP 请求，不阻塞机器人
- 完整的错误处理和用户友好提示
- 资源管理和会话清理
- 智能图片组件识别和处理
- 支持自动裁切黑边功能
- 基于 multipart/form-data 的文件上传
- 消息链支持，可发送富媒体内容（图片预览）
- 权限控制，管理功能仅限管理员使用
- 灵活的配置系统，支持多种自定义选项

## 版本历史

### v1.0.8 (最新版本)
- 🔧 **引用消息支持增强** - 修复 Reply 组件图片提取，现已支持各平台引用消息中的图片识别
- ⏱️ **自动超时通知** - 等待模式超时后自动发送取消通知，优化用户体验
- 🗑️ **功能简化** - 删除 URL/链接提取功能，专注于图片文件和引用消息两种输入方式
- 🔨 **命令重复触发修复** - 修复 `/搜番` 命令与 `on_message` 处理器冲突导致的双重响应问题
- 📊 **日志优化** - 统一优先级日志格式（✓/✗ 指示），便于调试和监控
- 🧹 **代码清理** - 移除冗余的 URL 提取方法，优化消息处理逻辑

### v1.0.7
- 🎆 移除 `/tracemoe cut` 命令，简化使用方式

### v1.0.6
- 📝 移除视频预览功能，仅保留图片预览
- 🔧 简化配置选项，提高稳定性
- ⚙️ 优化预览功能逻辑

### v1.0.5

本版本无新增功能，主要为重构代码逻辑

### v1.0.4
- ✨ 新增 API 密钥配置支持
- 🎬 新增预览媒体功能（图片/视频）
- 📊 新增配额查询指令（仅管理员）
- ⚙️ 新增灵活的配置选项
- 🔒 管理功能权限控制
- 🐛 修复返回类型和消息链支持

### v1.0.3
- 📊 支持自定义返回结果数量配置

### v1.0.2
- ⚙️ 支持自定义 API 接口地址配置

### v1.0.1
- 🐛 优化错误处理和用户体验

### v1.0.0
- 🎉 首个正式版本
- 🔍 基础动漫场景识别功能

## 数据来源

- [trace.moe](https://trace.moe/) - 动漫场景搜索引擎
- [AniList](https://anilist.co/) - 动漫数据库
- [MyAnimeList](https://myanimelist.net/) - 动漫信息网站

## 支持与反馈

如果遇到问题或有建议，请在项目的 GitHub Issues 中反馈。

---

## AstrBot Plugin Template

This plugin is based on AstrBot plugin template.

**Documentation**: [AstrBot 帮助文档](https://docs.astrbot.app)  
**Template**: [Github 仓库](https://github.com/Soulter/helloworld)
